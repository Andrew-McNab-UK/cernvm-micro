include $(TOP)/config.mk
include config.mk

PATCHELF_BINARY = patchelf-$(PATCHELF_STRONG_VERSION)/bin/patchelf
PATCHELF_BUILD_PRODUCT = $(PATCHELF_SOURCETREE)/src/patchelf
PATCHELF_STRIPPED = $(PATCHELF_BUILD_PRODUCT)-stripped
PATCHELF_MAKEFILE = $(PATCHELF_SOURCETREE)/Makefile
PATCHELF_CONFIGURE = $(PATCHELF_SOURCETREE)/configure
PATCHELF_BOOTSTRAP = $(PATCHELF_SOURCETREE)/bootstrap.sh

all: $(PATCHELF_BINARY)

clean:
	rm -rf patchelf-*

$(PATCHELF_BINARY): $(PATCHELF_STRIPPED)
	mkdir -p patchelf-$(PATCHELF_STRONG_VERSION)/bin
	cp $(PATCHELF_STRIPPED) $(PATCHELF_BINARY)

$(PATCHELF_STRIPPED): $(PATCHELF_BUILD_PRODUCT)
	cp $(PATCHELF_BUILD_PRODUCT) $(PATCHELF_STRIPPED)
	strip $(PATCHELF_STRIPPED)

$(PATCHELF_BUILD_PRODUCT): $(PATCHELF_MAKEFILE)
	$(MAKE) -j4 -C $(PATCHELF_SOURCETREE)

$(PATCHELF_CONFIGURE): $(PATCHELF_BOOTSTRAP)
	cd $(PATCHELF_SOURCETREE) && ./bootstrap.sh

$(PATCHELF_MAKEFILE): $(PATCHELF_CONFIGURE)
	cd $(PATCHELF_SOURCETREE) && ./configure

$(PATCHELF_BOOTSTRAP): | $(PATCHELF_TARBALL)
	tar -xvzf $(PATCHELF_TARBALL)

$(PATCHELF_TARBALL):
	curl -L $(PATCHELF_SOURCE) > $(PATCHELF_TARBALL) 2>/dev/null || rm -f $(PATCHELF_TARBALL)
